# AWS S3 ì‚¬ìš© ì„¤ëª…ì„œ



## 1. ë²„í‚· ìƒì„±

- AWS ì ‘ì†

![image-20210204215259333](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215259333.png)



- ë¡œê·¸ì¸

![image-20210204215441976](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215441976.png)



- ìŠ¤í† ë¦¬ì§€ > **S3** í´ë¦­

![image-20210204215350490](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215350490.png)



- ë„¤ë¹„ê²Œì´ì…˜ë°” ì•„ë˜ ì™¼ìª½ > `ë²„í‚· ë§Œë“¤ê¸°` í´ë¦­

![image-20210204215545200](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215545200.png)



- ë²„í‚· ì´ë¦„ ì…ë ¥ (ì¤‘ë³µ ë¶ˆê°€) > ë¦¬ì „ ì„ íƒ (ì‚¬ìš©ìì™€ ê°€ê¹Œìš¸ìˆ˜ë¡ ê³ ì†) > í¼ë¸”ë¦­ ì—‘ì„¸ìŠ¤ ì°¨ë‹¨ì„ ìœ„í•œ ë²„í‚· ì„¤ì • (ì¼ë‹¨ ì™¸ë¶€ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ **ëª¨ë“  í¼ë¸”ë¦­ ì—‘ì„¸ìŠ¤ ì°¨ë‹¨**ì˜ ì²´í¬ë¥¼ í•´ì œ, ì„ íƒì€ ìì‹ ì˜ ëª«ìœ¼ë¡œ ì™¸ë¶€ì˜ ê³µê²©ìì— ëŒ€í•œ ë³´í˜¸ ë¶ˆê°€, ì ì ˆí•œ í¼ë¸”ë¦­ ì—‘ì„¸ìŠ¤ ì°¨ë‹¨ í™œì„±í™” ì¶”ì²œ, ì°¨í›„ì— S3 ìƒì„± í›„ ê¶Œí•œì—ì„œ ì„¤ì • ë³€ê²½ ê°€ëŠ¥) > ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨ì— `ë²„í‚· ë§Œë“¤ê¸°` í´ë¦­

![image-20210204220437454](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204220437454.png)



## 2. access key ID, secret access key ë°œê¸‰

```
https://keichee.tistory.com/298
https://www.44bits.io/ko/post/publishing_and_managing_aws_user_access_key
```



- ë„¤ë¹„ê²Œì´ì…˜ë°” > `ğŸ””` ë²„íŠ¼ ì˜† > ìì‹ ì˜ ê³„ì • í´ë¦­ > ë“œë¡­ë‹¤ìš´ > **ë‚´ ë³´ì•ˆ ìê²© ì¦ëª…** í´ë¦­

![image-20210204215559934](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215559934.png)



- ì™¼ìª½ ì‚¬ì´ë“œë°” > ëŒ€ì‹œë³´ë“œ > ì—‘ì„¸ìŠ¤ ê´€ë¦¬ > **ì‚¬ìš©ì** í´ë¦­

![image-20210204215622805](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215622805.png)



- ìœ„ìª½ í—¤ë” > `ì‚¬ìš©ì ì¶”ê°€` ë²„íŠ¼ í´ë¦­

![image-20210204215644058](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215644058.png)



- ì‚¬ìš©ì ì´ë¦„ : ì´ë¦„ ì…ë ¥ (ì¤‘ë³µ í—ˆìš©) > ì—‘ì„¸ìŠ¤ ìœ í˜• : **í”„ë¡œê·¸ë˜ë° ì—‘ì„¸ìŠ¤** ì²´í¬ë°•ìŠ¤ í´ë¦­ > í•˜ë‹¨ì— `ë‹¤ìŒ:ê¶Œí•œ` ë²„íŠ¼ í´ë¦­

![image-20210204215711394](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204215711394.png)



- ê¶Œí•œ ì„¤ì • : 3ë²ˆì§¸ì¸ `ê¸°ì¡´ ì •ì±… ì§ì ‘ ì—°ê²°` í´ë¦­ > ğŸ”ê²€ìƒ‰ì°½ì— **S3** ì…ë ¥ > ê²°ê³¼ì°½ì— ë‚˜ì˜¨ ì •ì±… ì¤‘ `AmazonS3FullAccess` ì²´í¬ë°•ìŠ¤ í´ë¦­ > í•˜ë‹¨ì— `ë‹¤ìŒ:íƒœê·¸` í´ë¦­

![image-20210204221101045](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204221101045.png)



- ì´ë²ˆ í˜ì´ì§€ëŠ” ë„˜ì–´ê°„ë‹¤(ëª¨ë¥´ëŠ” ë‚´ìš©) > í•˜ë‹¨ì— `ë‹¤ìŒ:ê²€í† ` í´ë¦­

![image-20210204221554482](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204221554482.png)



- ìì‹ ì˜ ì„ íƒê³¼ ë™ì¼í•œì§€ ë‚´ìš© í™•ì¸ í›„ > í•˜ë‹¨ì— `ë‹¤ìŒ:ê²€í† ` í´ë¦­

![image-20210204221642102](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204221642102.png)



- access key ID, secret access key ë°œê¸‰ ì™„ë£Œ > secret access keyëŠ” **í‘œì‹œ**ë¥¼ ëˆŒë ¤ì•¼ ë³´ì¸ë‹¤. > ì´ê²ƒì„ ê³µê°œì ìœ¼ë¡œ gitì— ì˜¬ë¦¬ë©´ ì•ˆëœë‹¤. > ë•Œë¬¸ì— application.properitiesì—ì„œë„ ì´ìš© í›„ git.ignoreì— ì¶”ê°€í•˜ì—¬ ê³µê°œë˜ëŠ” ê²ƒì„ ë§ŠëŠ”ë‹¤. (í•˜ì§€ë§Œ íƒí”„ë¡œì íŠ¸ì—¬ì„œ ë§Šì„ ìˆ˜ê°€ ì—†ì–´ì„œ ê³ ë¯¼ì´ ëœë‹¤..)

![image-20210204221748154](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204221748154.png)



## 3. S3 í™œìš©

- porm.xml

```xml
...

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-aws-autoconfigure</artifactId>
    <version>2.2.1.RELEASE</version>
</dependency>

...
```



- application.properties

```
cloud.aws.credentials.accessKey=ìì‹ ì˜accessKey
cloud.aws.credentials.secretKey=ìì‹ ì˜secretKey
cloud.aws.s3.bucket=ìì‹ ì˜bucketëª…
cloud.aws.region.static=ìì‹ ì˜bucketë¦¬ì „
cloud.aws.stack.auto=false # ì´ê²ƒì€ ì™œí•˜ëŠ”ì§€ ê¸°ì–µì´ ì•ˆë‚˜ëŠ”ë° ë‹¤ë“¤ í•´ì„œ í–ˆìŒ. ì•ˆí•´ë„ ë˜ì§€ë§Œ ì±…ì„ì€ ì•ˆì§„ë‹¤.
```



- S3Service.java

new Data().getTime()ì„ Stringìœ¼ë¡œ ë³€í™˜í•˜ì—¬ íŒŒì¼ì˜ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ì˜€ë‹¤. ì™œëƒí•˜ë©´ ê° ì´ë¯¸ì§€ íŒŒì¼ë§ˆë‹¤ ê³ ìœ ì˜ ì‹ë³„ìê°€ í•„ìš”í–ˆê¸° ë•Œë¬¸ì´ë‹¤. (Userì˜ IDë‚˜ Emailì„ íŒŒì¼ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•´ì„œ ì €ì¥í•˜ëŠ” ë°©ë²• ì¶”ê°€ë„ ê³ ë ¤ ì¤‘)

íŒŒì¼ì˜ ê³ ìœ ì˜ ì´ë¦„ì„ ì‚¬ìš©í•˜ë©´ íŒŒì¼ì˜ ì´ë¦„ì´ ê°™ìœ¼ë©´ ì¶©ëŒì´ ë°œìƒí•  ê²ƒ ê°™ì•„ ì œì¼ ë¨¼ì € ê¸°ê°, Userì˜ nicknameì´ë‚˜ id ê°™ì€ ê³ ìœ ì˜ ê°’ì„ ì‚¬ìš©í•˜ë ¤ê³  í–ˆëŠ”ë° í•œ ì‚¬ëŒì´ ì—¬ëŸ¬ ê°œì˜ ì‚¬ì§„ì„ ë“±ë¡í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê¸°ê°, ... 



êµ¬ê¸€ì— ì—¬ëŸ¬ ì‚¬ëŒì˜ ì½”ë“œë¥¼ ì°¸ê³  í–ˆëŠ”ë°, ì£¼ë¡œ ë°°ë‹¬ì˜ ë¯¼ì¡± ê°œë°œì ë¶„ì˜ ê²ƒì„ ì°¨ìš©í–ˆë‹¤. 

í•˜ì§€ë§Œ ê·¸ë¶„ì˜ ì†ŒìŠ¤ì—ì„œ ajaxë¥¼ í†µí•´ Multipartfile í˜•íƒœë¡œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë„˜ê¸°ëŠ”ë° 

axiosë¡œ Multipartfile í˜•íƒœë¡œ ë„˜ê¸°ê¸° ìœ„í•´ì„œëŠ” header ì— Context-typeì„ ì„ ì—°í•´ì•¼ í•˜ëŠ”ë° ë‹¤ë¥¸ ë°ì´í„°ë“¤ì„ jsonìœ¼ë¡œ ë³´ë‚´ì•¼í•˜ê¸° ë•Œë¬¸ì— ì‚¼ì§ˆì„ ì¢€ í–ˆë‹¤... (ì—¬ê¸°ì„œ ëŒ€ë¶€ë¶„ì˜ ì‹œê°„ì„ í—ˆë¹„)

ì²˜ìŒì—ëŠ” í†µì‹ ì„ 2ê°œ ë”°ë¡œ ë³´ë‚¼ê¹Œ í–ˆëŠ”ë° ë¹ˆ ëª¨ ê°œë°œìê°€ ë§Œë“¤ì–´ë‘” ì†ŒìŠ¤ë¥¼ ì´ìš©í•´ì„œ json(string) í˜•íƒœë¡œ fileì„ ë³€í™˜í•´ì„œ ì „ì†¡í•œ ê²ƒì„ byteë¡œ íŒŒì‹±í•´ì„œ íŒŒì¼ì„ ë§Œë“œëŠ” ë¶€ë¶„ì„ ì•Œì°¨ê²Œ ì‚¬ìš©í–ˆë‹¤. (ê³ ë§™ë‹¤.. ã…‚ã…ˆã… ê°œë°œì...)



ì•„ë˜ì˜ serviceë¥¼ ì‚¬ìš©í•˜ë©´

í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ AWS S3 ì„œë²„ì— ì˜¬ë¦¬ê³ ,

í•´ë‹¹ urlì„ ë°›ì•„ì™€ì„œ,

ê·¸ urlì„ <img :src="url" alt=""\> ì´ëŸ° ì‹ìœ¼ë¡œ ë°”ë¡œ ë°”ì¸ë”©í•´ì„œ ì“°ë©´

í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤!



ìì²´ì ìœ¼ë¡œ ê°œë°œí•  ìˆ˜ë„ ìˆì„ ê²ƒ ê°™ì§€ë§Œ ë¬´ì—‡ì¸ê°€ ê·€ì°®ì€ ì¼ë“¤ì´ ë”ìš± ìƒê¸¸ ê²ƒ ê°™ì•„ ì‹ ë¢°ì„± ê·¹ê°•ì˜ ì™¸ë¶€ ì„œë²„ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒ í¸í•˜ë‹¤.

```java
package com.ssafy.ssafying.model.service;

import java.io.File;
import java.io.IOException;

import com.amazonaws.auth.AWSCredentials;
import com.amazonaws.auth.AWSStaticCredentialsProvider;
import com.amazonaws.auth.BasicAWSCredentials;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.AmazonS3ClientBuilder;
import com.amazonaws.services.s3.model.CannedAccessControlList;
import com.amazonaws.services.s3.model.PutObjectRequest;
import com.ssafy.ssafying.model.UserDto;

import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;

import java.io.ByteArrayInputStream;
import javax.imageio.ImageIO;
import javax.xml.bind.DatatypeConverter;


@Slf4j
@Service
@NoArgsConstructor
public class S3Service {
    private AmazonS3 s3Client;

    @Value("${cloud.aws.credentials.accessKey}")
    private String accessKey;

    @Value("${cloud.aws.credentials.secretKey}")
    private String secretKey;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    @Value("${cloud.aws.region.static}")
    private String region;

    @PostConstruct
    public void setS3Client() {
        AWSCredentials credentials = new BasicAWSCredentials(this.accessKey, this.secretKey);

        s3Client = AmazonS3ClientBuilder.standard()
                .withCredentials(new AWSStaticCredentialsProvider(credentials))
                .withRegion(this.region)
                .build();
    }

    public String upload(UserDto userDto, String dirName) throws Exception{
        File uploadFile = createNewFile(userDto);
        String uploadImageUrl = putS3(uploadFile, dirName);
        removeNewFile(uploadFile);
        return uploadImageUrl;
    }

    private File createNewFile(UserDto userDto) throws Exception{
        String url = System.getProperty("user.dir") + userDto.getNickname() + ".png";

        File uploadFile = new File(url);
        String jsonData = userDto.getProfileImage();
        byte[] BinaryData = DatatypeConverter.parseBase64Binary(jsonData.substring(jsonData.indexOf(",") + 1));
        ImageIO.write(ImageIO.read(new ByteArrayInputStream(BinaryData)), "png", uploadFile);
        
        return uploadFile;
    }

    private String putS3(File uploadFile, String dirName) {
        s3Client.putObject(new PutObjectRequest(bucket, dirName, uploadFile)
                .withCannedAcl(CannedAccessControlList.PublicRead));
        return s3Client.getUrl(bucket, dirName).toString();
    }

    private void removeNewFile(File targetFile) {
        if (targetFile.delete()) {
            log.info("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            log.info("íŒŒì¼ì´ ì‚­ì œë˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }
}
```



- AWS S3 ë²„í‚·ì— ì—…ë¡œë“œëœ ì‚¬ì§„ 2ì¥

![image-20210204223142746](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204223142746.png)



- MySQL DBì— User Tableì— ë“±ë¡ëœ AWS S3ì—ì„œ í• ë‹¹ëœ url ì£¼ì†Œê°€ ì €ì¥ë˜ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image-20210204223320107](%EC%9D%B4%EA%B0%95%EB%A6%BC.assets/image-20210204223320107.png)



- ì°¸ê³ ë¡œ AWS S3 ë¹„ìš© ì •ì±…ì„ ìì„¸íˆëŠ” ëª°ë¼ì„œ ìµœëŒ€í•œ ì ì€ í¬ê¸°ì˜ ì´ë¯¸ì§€ íŒŒì¼ì„ ì‚¬ìš©í•´ ì£¼ê¸°ë¥¼ ê¶Œì¥í•œë‹¤. ê·¸ë¦¬ê³  ì´ë¥¼ ìœ„í•´ ì°¨í›„ì— ì‚¬ìš©ìë“¤ì—ê²Œë„ ì ìš©í•˜ê¸° ìœ„í•´ Frontendë‚˜ Backendì—ì„œ íŒŒì¼ì˜ í¬ê¸°ë¥¼ ê²€ì‚¬í•˜ì—¬ ì¼ì • ì´ìƒì˜ í¬ê¸°ëŠ” ê±°ë¶€í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í•  ê²ƒì´ë‹¤. (30KBë„ ì¶©ë¶„íˆ ì‹ë³„ê°€ëŠ¥í•˜ë‹¤...)